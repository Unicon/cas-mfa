# Kicking the tires

These are the minimal instructions for building, deploying, and exercising the example customized CAS server in this project.

These are not the instructions for incorporating the solution into your local Maven overlay, but this walkthrough is a good first step before you try to do that.

## Get the Source Code

Since the project code is hosted on Github and managed by the [Git source control system](http://git-scm.com/), you have the following options to download the codebase:

1. [Download](https://github.com/Unicon/cas-mfa/archive/master.zip) the `master` branch as a ZIP archive.
2. Platform-specific options:
2.a. If you are in a Windows environment and have "[Github for Windows](http://windows.github.com/)" installed, you can directly clone the repo using [the following link](github-windows://openRepo/https://github.com/Unicon/cas-mfa)
2.b. If you are in a MacOS environment and have "[GitHub for Mac](http://mac.github.com/)" installed, you can directly clone the repo jusing [this link](github-mac://openRepo/https://github.com/Unicon/cas-mfa)
3. Alternatively, using your favorite Git client you can directly clone the repository using the following command: `git clone https://github.com/Unicon/cas-mfa.git cas-mfa`

## Software Dependencies

### Build-time dependencies

In order to build a deployable `.war` file, you'll need Apache Maven.  Maven in turn requires Java.

* [Apache Maven](http://maven.apache.org): Maven is responsible for managing the project's build and dependency resolution. The build requires that you have, at minimum, installed the version `3.0.0`. You will also need to create the environment variable `MAVEN_HOME` that points to the directory of your Maven installation. You should also add the `$MAVEN_HOME/bin` directory to your `$PATH` environment variable so that you can easily run the `mvn` from the command prompt. The Maven is build is managed by a parent `pom.xml` file at the root of the project directory which orchestrates the entire build by having to invoke other child `pom.xml` files that each sub module presents locally.

  Test the installation by running `mvn --version` from the command prompt.

    $ mvn --version
    Apache Maven 3.0.3 (r1075438; 2011-02-28 12:31:09-0500)
    Maven home: /usr/share/maven
    Java version: 1.6.0_45, vendor: Apple Inc.
    Java home: /System/Library/Java/JavaVirtualMachines/1.6.0.jdk/Contents/Home
    Default locale: en_US, platform encoding: MacRoman
    OS name: "mac os x", version: "10.8.3", arch: "x86_64", family: "mac"
    $


* [Java](http://java.com): At minimum, you should have `1.6` installed. Configure the `$JAVA_HOME` environment variable to point to your JDK and/or JRE installation, and add `$JAVA_HOME/bin` to your $PATH variable.

  Test the installation by running `java --version` from the command prompt.

    $ java -version
    java version "1.6.0_45"
    Java(TM) SE Runtime Environment (build 1.6.0_45-b06-451-11M4406)
    Java HotSpot(TM) 64-Bit Server VM (build 20.45-b01-451, mixed mode)
    $


#### Ant is optional

Optionally, you can choose to use Ant to automate some of the tasks around building from source, deploying to Tomcat, stopping and starting Tomcat, etc.  This is entirely optional.  These instructions assume you *aren't* using the Ant build script (because while the script adds some convenience, it also adds another layer of properly installing the right versions of things, and the manual steps are useful for understanding the software's requirements.

### Run-time dependencies

The CAS server in general has oodles of runtime Java library dependencies, and this CAS server extension is no exception.  However, those dependencies will be packed into the `.war` file generated by Maven, so you shouldn't have to particularly worry about them.

You'll need to deploy the resulting `.war` file into a servlet container.  Apache Tomcat is recommended and is the container the authors used in testing.

* [Apache Tomcat](http://tomcat.apache.org): The preferred server environment for deployment, which is to host the final `WAR` file produced by a successful build. The recommended version to install is `7.0.42`. **You should also configure the server environment to have `SSL/HTTPS` enabled.**  Configuring HTTPS is recommended because CAS will not honor single sign-on sessions except over https:// and the solution is less interesting if you are unable to test the cases where users have existing single sign-on sessions.

## Project Structure

This project is currently structured as three sub-projects:

* `cas-mfa-java`: Java classes and interfaces that build to a .jar
* `cas-mfa-web`: Web components (JSPs, Spring Web Flow configuration, etc.) that build to a .war. These Web components can depend on the `cas-mfa-java.jar`
* `webapp-overlay-example`: An example of how a CAS adopter would compose a local good-practices maven overlay configuration to build a localized CAS server incorporating the features in this project.  It is the `.war` that this project generates that we'll be trying out in these instructions.

## Build

This project is currently configured to integrate with (build atop) CAS server `v3.5.2`.

### Configuration before build

The source code includes the path to the `cas.properties` file to be relied upon at runtime.  By default this path is `/etc/cas/cas.properties`.  Externalizing environment-specific configuration to a standard location allows an unmodified .war file to be migrated from one server to another.

If you'd like to use a path other than `/etc/cas/cas.properties`, you'll need to edit `cas-mfa/webapp-overlay-example/src/main/webapp/WEB-INF/spring-configuration/propertyFileConfigurer.xml` *before* running the build, or edit the `propertyFileConfigurer.xml` within the .war file or exploded web application directory after running the build.  You might be especially interested in changing this path if you're building for local testing in an environment where you maintain other CAS server configuration and wish to isolate this cas-mfa project's configuration.

For example, in Andrew's environment `propertyFileConfigurer.xml` is customized to

    <context:property-placeholder location="file:/Users/apetro/Documents/cas_config/cas_mfa/cas.properties"/>

### Maven Build

From the command line at the project root directory, run `mvn clean package`. The final produced `cas.war` file will be available at `webapp-overlay-example/target/cas.war`.


## Configuration after build

Above, you may have customized `propertyFileConfigurer.xml` to find the `cas.properties` file at a location other than `/etc/cas/cas.properties` or you may have kept the default.  Wherever CAS is configured to find `cas.properties`, you'll need a `cas.properties` file to be there.  You can base your `cas.properties` on `cas-mfa/webapp-overlay-example/etc/cas.properties`.



Particularly important are the properties providing paths to `log4j.xml`, `servicesRegistry.conf`, and `person-attributes.conf`.

    log4j.config.location=/etc/cas/log4j.xml
    
    services.registry.config.location=file:/etc/cas/servicesRegistry.conf
    person.attributes.config.location=file:/etc/cas/person-attributes.conf

These paths default to `/etc/cas/` but are customizable in `cas.properties`.  You can find suitable samples for each of these files in `cas-mfa/webapp-overlay-example/etc/`

Note that `log4j.xml` includes the desired path for the CAS server log file, which you should customize if you don't want that log appearing in `/etc/cas/log/`.

    <param name="File" value="/etc/cas/log/cas.log" />

## Deployment

With `propertyFileConfigurer.xml` optionally customized to specify `cas.properties` somewhere other than `/etc/cas/` and a copy of `cas.properties` placed where CAS is configured to find it, and with that copy of `cas.properties` specifying paths that work for the log4j, service registry, and person registry configuration you can then drop the .war file into the servlet container's `webapps` directory.  Maven will have produced the .war file at `webapp-overlay-example/target/cas.war`

### Deployment suggestions
* Ensure that Tomcat stopped completely before starting it anew
* Always ensure that all previously deployed instances of the WAR file and exploded directories are deleted before a new deployment.
* Consider deleting previously generated log files to start afresh after every deployment. This will focus the logs on only the record of the latest deployment's behavior.



## Exercising the deployed CAS server

Once you've successfully deployed the CAS server, you can exercise it.  Here are some recipes of ways you can exercise the server and what you should expect.

The example URLs here assume you've deployed to https://localhost/cas .  You'll need to adjust these if you're not using https or if you're using another hostname.

### No authentication method specified

One set of behaviors to verify is that when no `authn_method` is specified, the CAS server behaves as would an unmodified CAS server.

You can log in to the server at `https://localhost/cas/login` just for the joy of establishing a single sign-on session outside the context of logging in to any particular service.  Mostly, real end users don't do this.

As a better example, you can obtain an ST to access www.unicon.net by accessing

    https://localhost/cas/login?service=http://www.unicon.net

In any case, CAS is configured to use the `SimpleTestUsernamePasswordAuthenticationHandler` which authenticates where the username is the same as the password.

Once you've done this, if you try it again to access another website, you'll experience single sign-on, unless you're not using `https://` in which case there will be no single sign-on session cookie so CAS will prompt for credentials every time.

### Strong Two Factor authentication method

Another set of behaviors to verify is that when `authn_method` is specified, the CAS server requires the additional authentication method.

    https://localhost/cas/login?authn_method=strong_two_factor&service=http://www.unicon.net


If there isn't an already-established single sign-on session, CAS will first prompt for traditional username and password as per normal.  (You can get through this login screen by presenting a username that is the same as its password, e.g. "demo" / "demo").

Then CAS will prompt for an additional authentication factor.  For demo purposes this is modeled as another username and password pair, with "casuser" as the only working username and "Mellon" as the only working password.

If you're using https://, then you can also verify that if you first log in with no `authn_method` specified (as above) to establish a not-particularly-strong single sign-on session, and then attempt to log in specifiying the `authn_method`, CAS will prompt for the second factor but not for the normal username and password.




